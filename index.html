<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Framework Lesson 5: Refactoring For Flexibility</title>
  </head>
  <body>
    <div x-data="{count: 0}">
      <button @click="count += 1">+</button>
      <button @click="count -= 1">-</button>
      <span x-text="count"></span>
    </div>

    <script>
      // https://github.com/salesforce/observable-membrane
      let root = document.querySelector("[x-data]");
      let data = observe(getInitialData(root));

      function observe(object) {
        return new Proxy(object, {
          set(target, key, value) {
            target[key] = value;
            refreshDOM();
          },
        });
      }
      registerListeners();
      refreshDOM();

      function getInitialData(element) {
        return eval(`(${element.getAttribute("x-data")})`);
      }

      function execute(expression) {
        return eval(`with(data) {(${expression})}`);
      }

      function registerListeners() {
        walkDOM(root, (el) => {
          if (el.hasAttribute("@click")) {
            let expression = el.getAttribute("@click");

            el.addEventListener("click", () => execute(expression));
          }
        });
      }

      function refreshDOM() {
        walkDOM(root, (el) => {
          if (el.hasAttribute("x-text")) {
            let expression = el.getAttribute("x-text");

            el.innerText = execute(expression);
          }
        });
      }

      function walkDOM(el, callback) {
        callback(el);

        el = el.firstElementChild;

        while (el) {
          walkDOM(el, callback);

          el = el.nextElementSibling;
        }
      }
    </script>
  </body>
</html>
